name: Build Sokol Libraries

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

# Required permissions for private repositories
permissions:
  contents: write  # Allow workflow to push commits back to repository

jobs:
  build-windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64]  # Can add Win32, ARM64 if needed
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Configure CMake
      run: |
        mkdir build-windows
        cd build-windows
        cmake ../ext -G "Visual Studio 17 2022" -A ${{ matrix.arch }}
    
    - name: Build Debug
      run: |
        cd build-windows
        cmake --build . --config Debug
    
    - name: Build Release
      run: |
        cd build-windows
        cmake --build . --config Release
    
    - name: Create output directories
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force "libs/windows/${{ matrix.arch }}/debug" | Out-Null
        New-Item -ItemType Directory -Force "libs/windows/${{ matrix.arch }}/release" | Out-Null
    
    - name: Copy artifacts
      shell: pwsh
      run: |
        $debugDll = "build-windows/Debug/sokol.dll"
        $debugLib = "build-windows/Debug/sokol.lib"
        $releaseDll = "build-windows/Release/sokol.dll"
        $releaseLib = "build-windows/Release/sokol.lib"
        
        $debugDestDir = "libs/windows/${{ matrix.arch }}/debug"
        $releaseDestDir = "libs/windows/${{ matrix.arch }}/release"
        
        # Function to check if file changed
        function ShouldCopyFile($sourcePath, $destPath) {
          if (!(Test-Path $sourcePath)) {
            Write-Host "Source file $sourcePath does not exist"
            return $false
          }
          
          if (!(Test-Path $destPath)) {
            Write-Host "Destination file $destPath does not exist - copying"
            return $true
          }
          
          $sourceHash = Get-FileHash $sourcePath -Algorithm SHA256
          $destHash = Get-FileHash $destPath -Algorithm SHA256
          
          if ($sourceHash.Hash -ne $destHash.Hash) {
            Write-Host "File $destPath changed (SHA256 differs) - copying"
            return $true
          } else {
            Write-Host "File $destPath unchanged - skipping copy"
            return $false
          }
        }
        
        # Copy debug files if changed
        if (ShouldCopyFile $debugDll "$debugDestDir/sokol.dll") {
          Copy-Item -Force $debugDll $debugDestDir/
        }
        if (ShouldCopyFile $debugLib "$debugDestDir/sokol.lib") {
          Copy-Item -Force $debugLib $debugDestDir/
        }
        
        # Copy release files if changed
        if (ShouldCopyFile $releaseDll "$releaseDestDir/sokol.dll") {
          Copy-Item -Force $releaseDll $releaseDestDir/
        }
        if (ShouldCopyFile $releaseLib "$releaseDestDir/sokol.lib") {
          Copy-Item -Force $releaseLib $releaseDestDir/
        }
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-${{ matrix.arch }}
        path: libs/windows/${{ matrix.arch }}/**/*
        retention-days: 30

  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [arm64, x86_64]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Configure and Build
      run: |
        mkdir build-macos-${{ matrix.arch }}
        cd build-macos-${{ matrix.arch }}
        
        # Configure for specific architecture
        cmake ../ext -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} -DCMAKE_BUILD_TYPE=Debug
        cmake --build . --config Debug
        
        # Create output directories
        mkdir -p ../libs/macos/${{ matrix.arch }}/debug
        
        # Check if debug library changed before copying
        if [ -f "../libs/macos/${{ matrix.arch }}/debug/libsokol.dylib" ]; then
          OLD_DEBUG_HASH=$(sha256sum "../libs/macos/${{ matrix.arch }}/debug/libsokol.dylib" | cut -d' ' -f1)
          NEW_DEBUG_HASH=$(sha256sum "libsokol.dylib" | cut -d' ' -f1)
          if [ "$OLD_DEBUG_HASH" = "$NEW_DEBUG_HASH" ]; then
            echo "Debug library unchanged - skipping copy"
          else
            echo "Debug library changed - copying"
            cp libsokol.dylib ../libs/macos/${{ matrix.arch }}/debug/
          fi
        else
          echo "Debug library doesn't exist - copying"
          cp libsokol.dylib ../libs/macos/${{ matrix.arch }}/debug/
        fi
        
        # Build Release
        cmake ../ext -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        
        mkdir -p ../libs/macos/${{ matrix.arch }}/release
        
        # Check if release library changed before copying
        if [ -f "../libs/macos/${{ matrix.arch }}/release/libsokol.dylib" ]; then
          OLD_RELEASE_HASH=$(sha256sum "../libs/macos/${{ matrix.arch }}/release/libsokol.dylib" | cut -d' ' -f1)
          NEW_RELEASE_HASH=$(sha256sum "libsokol.dylib" | cut -d' ' -f1)
          if [ "$OLD_RELEASE_HASH" = "$NEW_RELEASE_HASH" ]; then
            echo "Release library unchanged - skipping copy"
          else
            echo "Release library changed - copying"
            cp libsokol.dylib ../libs/macos/${{ matrix.arch }}/release/
          fi
        else
          echo "Release library doesn't exist - copying"
          cp libsokol.dylib ../libs/macos/${{ matrix.arch }}/release/
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-${{ matrix.arch }}
        path: libs/macos/${{ matrix.arch }}/**/*
        retention-days: 30

  build-linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            packages: ""
          # Note: ARM64 cross-compilation removed due to repository limitations
          # ARM64 builds should be done natively on ARM64 hardware
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libx11-dev \
          libxcursor-dev \
          libxi-dev \
          libasound2-dev \
          libgl1-mesa-dev \
          ${{ matrix.packages }}
    
    - name: Configure and Build
      run: |
        mkdir build-linux
        cd build-linux
        
        # Build Debug
        cmake ../ext -DCMAKE_BUILD_TYPE=Debug
        cmake --build . --config Debug
        mkdir -p ../libs/linux/${{ matrix.arch }}/debug
        
        # Check if debug library changed before copying
        if [ -f "../libs/linux/${{ matrix.arch }}/debug/libsokol.so" ]; then
          OLD_DEBUG_HASH=$(sha256sum "../libs/linux/${{ matrix.arch }}/debug/libsokol.so" | cut -d' ' -f1)
          NEW_DEBUG_HASH=$(sha256sum "libsokol.so" | cut -d' ' -f1)
          if [ "$OLD_DEBUG_HASH" = "$NEW_DEBUG_HASH" ]; then
            echo "Debug library unchanged - skipping copy"
          else
            echo "Debug library changed - copying"
            cp libsokol.so ../libs/linux/${{ matrix.arch }}/debug/
          fi
        else
          echo "Debug library doesn't exist - copying"
          cp libsokol.so ../libs/linux/${{ matrix.arch }}/debug/
        fi
        
        # Build Release
        cmake ../ext -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        mkdir -p ../libs/linux/${{ matrix.arch }}/release
        
        # Check if release library changed before copying
        if [ -f "../libs/linux/${{ matrix.arch }}/release/libsokol.so" ]; then
          OLD_RELEASE_HASH=$(sha256sum "../libs/linux/${{ matrix.arch }}/release/libsokol.so" | cut -d' ' -f1)
          NEW_RELEASE_HASH=$(sha256sum "libsokol.so" | cut -d' ' -f1)
          if [ "$OLD_RELEASE_HASH" = "$NEW_RELEASE_HASH" ]; then
            echo "Release library unchanged - skipping copy"
          else
            echo "Release library changed - copying"
            cp libsokol.so ../libs/linux/${{ matrix.arch }}/release/
          fi
        else
          echo "Release library doesn't exist - copying"
          cp libsokol.so ../libs/linux/${{ matrix.arch }}/release/
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-${{ matrix.arch }}
        path: libs/linux/${{ matrix.arch }}/**/*
        retention-days: 30

  build-web:
    name: Build Web (Emscripten)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: '3.1.34'
    
    - name: Build Debug
      run: |
        mkdir build-emscripten-debug
        cd build-emscripten-debug
        emcmake cmake ../ext -DCMAKE_BUILD_TYPE=Debug
        cmake --build .
        mkdir -p ../libs/emscripten/x86/debug
        
        # Check if debug library changed before copying
        if [ -f "../libs/emscripten/x86/debug/sokol.a" ]; then
          OLD_DEBUG_HASH=$(sha256sum "../libs/emscripten/x86/debug/sokol.a" | cut -d' ' -f1)
          NEW_DEBUG_HASH=$(sha256sum "sokol.a" | cut -d' ' -f1)
          if [ "$OLD_DEBUG_HASH" = "$NEW_DEBUG_HASH" ]; then
            echo "Debug library unchanged - skipping copy"
          else
            echo "Debug library changed - copying"
            cp sokol.a ../libs/emscripten/x86/debug/
          fi
        else
          echo "Debug library doesn't exist - copying"
          cp sokol.a ../libs/emscripten/x86/debug/
        fi
    
    - name: Build Release
      run: |
        mkdir build-emscripten-release
        cd build-emscripten-release
        emcmake cmake ../ext -DCMAKE_BUILD_TYPE=Release
        cmake --build .
        mkdir -p ../libs/emscripten/x86/release
        
        # Check if release library changed before copying
        if [ -f "../libs/emscripten/x86/release/sokol.a" ]; then
          OLD_RELEASE_HASH=$(sha256sum "../libs/emscripten/x86/release/sokol.a" | cut -d' ' -f1)
          NEW_RELEASE_HASH=$(sha256sum "sokol.a" | cut -d' ' -f1)
          if [ "$OLD_RELEASE_HASH" = "$NEW_RELEASE_HASH" ]; then
            echo "Release library unchanged - skipping copy"
          else
            echo "Release library changed - copying"
            cp sokol.a ../libs/emscripten/x86/release/
          fi
        else
          echo "Release library doesn't exist - copying"
          cp sokol.a ../libs/emscripten/x86/release/
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: emscripten-x86
        path: libs/emscripten/**/*
        retention-days: 30

  # Generate C# bindings from C headers
  # TODO: Fix binding generation in GitHub Actions - currently disabled
  # Issue: clang cannot find header files when running in CI environment  
  # Works locally but fails in GitHub Actions due to working directory issues
  # Need to investigate why clang subprocess doesn't respect working directory
  # For now, bindings must be generated and committed manually when sokol headers change
  
  # Combine all artifacts into a single release
  combine-artifacts:
    name: Combine All Libraries
    needs: [build-windows, build-macos, build-linux, build-web]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: libs
    
    - name: Reorganize artifacts
      run: |
        # Reorganize the downloaded artifacts into proper structure
        mkdir -p combined-libs
        
        # Windows
        if [ -d "libs/windows-x64" ]; then
          mkdir -p combined-libs/windows/x64
          cp -r libs/windows-x64/* combined-libs/windows/x64/ || true
        fi
        
        # macOS
        if [ -d "libs/macos-arm64" ]; then
          mkdir -p combined-libs/macos/arm64
          cp -r libs/macos-arm64/* combined-libs/macos/arm64/ || true
        fi
        if [ -d "libs/macos-x86_64" ]; then
          mkdir -p combined-libs/macos/x86_64
          cp -r libs/macos-x86_64/* combined-libs/macos/x86_64/ || true
        fi
        
        # Linux
        if [ -d "libs/linux-x86_64" ]; then
          mkdir -p combined-libs/linux/x86_64
          cp -r libs/linux-x86_64/* combined-libs/linux/x86_64/ || true
        fi
        if [ -d "libs/linux-aarch64" ]; then
          mkdir -p combined-libs/linux/aarch64
          cp -r libs/linux-aarch64/* combined-libs/linux/aarch64/ || true
        fi
        
        # Emscripten
        if [ -d "libs/emscripten-x86" ]; then
          mkdir -p combined-libs/emscripten
          cp -r libs/emscripten-x86/* combined-libs/emscripten/ || true
        fi
        
        # Show structure
        echo "Combined libraries structure:"
        find combined-libs -type f
    
    - name: Upload combined artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sokol-libraries-all-platforms
        path: combined-libs/**/*
        retention-days: 90
    
    - name: Create release archive
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        cd combined-libs
        tar -czf ../sokol-libraries.tar.gz *
        cd ..
        zip -r sokol-libraries.zip combined-libs/*
    
    - name: Upload release archives
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: actions/upload-artifact@v4
      with:
        name: sokol-libraries-archives
        path: |
          sokol-libraries.tar.gz
          sokol-libraries.zip
        retention-days: 90
    
    - name: Commit libraries to repository
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        # Checkout the repository (artifacts download doesn't include repo files)
        git clone --depth 1 --branch main https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git repo
        cd repo
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create backup of existing libraries for comparison
        echo "Backing up existing libraries for comparison..."
        mkdir -p ../old-libs
        if [ -d "libs/windows" ]; then 
          echo "  Backing up libs/windows..."
          cp -r libs/windows ../old-libs/ 2>/dev/null || true
        fi
        if [ -d "libs/macos" ]; then 
          echo "  Backing up libs/macos..."
          cp -r libs/macos ../old-libs/ 2>/dev/null || true
        fi
        if [ -d "libs/linux" ]; then 
          echo "  Backing up libs/linux..."
          cp -r libs/linux ../old-libs/ 2>/dev/null || true
        fi
        if [ -d "libs/emscripten" ]; then 
          echo "  Backing up libs/emscripten..."
          cp -r libs/emscripten ../old-libs/ 2>/dev/null || true
        fi
        echo "Backup complete. Contents of ../old-libs:"
        ls -la ../old-libs/ || echo "No old-libs directory"
        
        # Remove old libraries (if they exist)
        rm -rf libs/windows libs/macos libs/linux libs/emscripten
        
        # Ensure libs directory exists
        mkdir -p libs
        
        # Copy new libraries
        cp -r ../combined-libs/* libs/
        
        # Compare old and new libraries
        echo "Comparing old and new libraries..."
        CHANGES_DETECTED=false
        
        # Check if this is the first time (no old libraries exist)
        if [ ! -d "../old-libs" ] || [ -z "$(ls -A ../old-libs 2>/dev/null)" ]; then
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ†• First time setup - no existing libraries found"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          CHANGES_DETECTED=true
        else
          # Function to compare directories using checksums
          compare_libs() {
            local platform=$1
            echo "Checking $platform..."
            
            if [ ! -d "../old-libs/$platform" ]; then
              echo "  - $platform: New platform detected (../old-libs/$platform doesn't exist)"
              CHANGES_DETECTED=true
              return
            fi
          
          # Compare using checksums (handles binary files correctly)
          echo "  - Computing OLD_HASH for ../old-libs/$platform..."
          OLD_HASH=$(find ../old-libs/$platform -type f -exec sha256sum {} \; 2>/dev/null | sort | sha256sum | cut -d' ' -f1)
          echo "  - OLD_HASH: $OLD_HASH"
          
          echo "  - Computing NEW_HASH for libs/$platform..."
          NEW_HASH=$(find libs/$platform -type f -exec sha256sum {} \; 2>/dev/null | sort | sha256sum | cut -d' ' -f1)
          echo "  - NEW_HASH: $NEW_HASH"
          
          if [ "$OLD_HASH" != "$NEW_HASH" ]; then
            echo "  - $platform: Changes detected (hashes differ)"
            CHANGES_DETECTED=true
          else
            echo "  - $platform: No changes (hashes match)"
          fi
        }
        
          # Check each platform
          if [ -d "libs/windows" ]; then compare_libs "windows"; fi
          if [ -d "libs/macos" ]; then compare_libs "macos"; fi
          if [ -d "libs/linux" ]; then compare_libs "linux"; fi
          if [ -d "libs/emscripten" ]; then compare_libs "emscripten"; fi
        fi
        
        # Only commit if changes were detected
        if [ "$CHANGES_DETECTED" = false ]; then
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… No library changes detected - skipping commit"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 0
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ Library changes detected - committing..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Stage changes
        git add libs/
        
        # Double-check git detected changes
        if git diff --cached --quiet; then
          echo "Git reports no changes to commit (false positive from comparison)"
          exit 0
        fi
        
        # Commit and push
        git commit -m "Auto-update built libraries [skip ci]
        
        Built from commit: ${{ github.sha }}
        Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        
        Platform sizes:
        - Windows x64: $(du -sh libs/windows/x64 | cut -f1)
        - macOS arm64: $(du -sh libs/macos/arm64 | cut -f1)
        - macOS x86_64: $(du -sh libs/macos/x86_64 | cut -f1)
        - Linux x86_64: $(du -sh libs/linux/x86_64 | cut -f1)
        - Emscripten: $(du -sh libs/emscripten | cut -f1)"
        
        git push origin main
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Libraries committed and pushed successfully"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
